# ============================================================================
# Makefile - Walmart Demand Forecasting
# ============================================================================
# AutomatizaciÃ³n de tareas comunes del proyecto
#
# Autor: Ing. Daniel Varela Perez
# Email: bedaniele0@gmail.com
# Tel: +52 55 4189 3428
# MetodologÃ­a: DVP-PRO
# ============================================================================

.PHONY: help install install-dev clean test lint format train predict api dashboard docker-build docker-up monitor docs

# Variables
BOOTSTRAP_PYTHON := $(shell command -v python3 || command -v python)
PYTHON := $(if $(wildcard ./venv/bin/python),./venv/bin/python,$(BOOTSTRAP_PYTHON))
PIP := $(PYTHON) -m pip
VENV := venv
PROJECT_NAME := walmart-demand-forecasting
PORT_API := 8000
PORT_DASHBOARD := 8501
PORT_MLFLOW := 5000

# Colores para output
BLUE := \033[0;34m
GREEN := \033[0;32m
YELLOW := \033[1;33m
RED := \033[0;31m
NC := \033[0m # No Color

# ============================================================================
# AYUDA Y DOCUMENTACIÃ“N
# ============================================================================

help: ## Mostrar este mensaje de ayuda
	@echo "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(BLUE)â•‘  $(GREEN)Walmart Demand Forecasting - Makefile Commands$(BLUE)       â•‘$(NC)"
	@echo "$(BLUE)â•‘  $(YELLOW)Ing. Daniel Varela Perez | DVP-PRO Methodology$(BLUE)         â•‘$(NC)"
	@echo "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(GREEN)Comandos disponibles:$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""

# ============================================================================
# INSTALACIÃ“N Y CONFIGURACIÃ“N
# ============================================================================

install: ## Instalar proyecto en modo producciÃ³n
	@echo "$(BLUE)ğŸ“¦ Instalando dependencias de producciÃ³n...$(NC)"
	$(PIP) install -e .
	@echo "$(GREEN)âœ… InstalaciÃ³n completada$(NC)"

install-dev: ## Instalar proyecto en modo desarrollo (con deps dev)
	@echo "$(BLUE)ğŸ“¦ Instalando dependencias de desarrollo...$(NC)"
	$(PIP) install -e ".[dev]"
	@echo "$(GREEN)âœ… InstalaciÃ³n de desarrollo completada$(NC)"

install-all: ## Instalar todas las dependencias (prod + dev + mlops)
	@echo "$(BLUE)ğŸ“¦ Instalando todas las dependencias...$(NC)"
	$(PIP) install -e ".[all]"
	@echo "$(GREEN)âœ… InstalaciÃ³n completa terminada$(NC)"

venv: ## Crear entorno virtual
	@echo "$(BLUE)ğŸ”§ Creando entorno virtual...$(NC)"
	$(BOOTSTRAP_PYTHON) -m venv $(VENV)
	@echo "$(GREEN)âœ… Entorno virtual creado en ./$(VENV)$(NC)"
	@echo "$(YELLOW)ğŸ’¡ Activa con: source $(VENV)/bin/activate$(NC)"

# ============================================================================
# LIMPIEZA
# ============================================================================

clean: ## Limpiar archivos temporales y cache
	@echo "$(BLUE)ğŸ§¹ Limpiando archivos temporales...$(NC)"
	find . -type f -name '*.pyc' -delete
	find . -type d -name '__pycache__' -delete
	find . -type d -name '*.egg-info' -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name '.pytest_cache' -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name '.mypy_cache' -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name 'htmlcov' -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name '.coverage' -delete 2>/dev/null || true
	@echo "$(GREEN)âœ… Limpieza completada$(NC)"

clean-all: clean ## Limpieza profunda (incluye modelos y logs)
	@echo "$(BLUE)ğŸ§¹ Limpieza profunda...$(NC)"
	rm -rf logs/*.log 2>/dev/null || true
	rm -rf reports/figures/*.png 2>/dev/null || true
	rm -rf mlruns/ 2>/dev/null || true
	@echo "$(GREEN)âœ… Limpieza profunda completada$(NC)"

# ============================================================================
# TESTING Y CALIDAD DE CÃ“DIGO
# ============================================================================

test: ## Ejecutar tests unitarios
	@echo "$(BLUE)ğŸ§ª Ejecutando tests...$(NC)"
	$(PYTHON) -m pytest tests/ -v --cov=src --cov-report=term-missing

test-fast: ## Ejecutar tests sin coverage (rÃ¡pido)
	@echo "$(BLUE)âš¡ Ejecutando tests rÃ¡pidos...$(NC)"
	$(PYTHON) -m pytest tests/ -v

test-cov: ## Ejecutar tests con reporte HTML de coverage
	@echo "$(BLUE)ğŸ“Š Generando reporte de cobertura...$(NC)"
	$(PYTHON) -m pytest tests/ -v --cov=src --cov-report=html
	@echo "$(GREEN)âœ… Reporte generado en htmlcov/index.html$(NC)"

test-integration: ## Ejecutar solo tests de integraciÃ³n
	@echo "$(BLUE)ğŸ”— Ejecutando tests de integraciÃ³n...$(NC)"
	$(PYTHON) -m pytest tests/ -v -m integration

lint: ## Ejecutar linters (flake8, mypy)
	@echo "$(BLUE)ğŸ” Ejecutando linters...$(NC)"
	$(PYTHON) -m flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
	$(PYTHON) -m flake8 src/ --count --exit-zero --max-complexity=10 --max-line-length=100
	$(PYTHON) -m mypy src/ --ignore-missing-imports

format: ## Formatear cÃ³digo con black
	@echo "$(BLUE)âœ¨ Formateando cÃ³digo...$(NC)"
	$(PYTHON) -m black src/ tests/
	$(PYTHON) -m isort src/ tests/
	@echo "$(GREEN)âœ… CÃ³digo formateado$(NC)"

check: lint test ## Ejecutar todas las validaciones (lint + test)
	@echo "$(GREEN)âœ… Todas las validaciones pasaron$(NC)"

# ============================================================================
# MACHINE LEARNING - ENTRENAMIENTO Y PREDICCIÃ“N
# ============================================================================

train: ## Entrenar modelo de demand forecasting
	@echo "$(BLUE)ğŸš€ Entrenando modelo de demand forecasting...$(NC)"
	$(PYTHON) -m src.models.train_demand
	@echo "$(GREEN)âœ… Entrenamiento completado$(NC)"

predict: ## Realizar predicciones (requiere modelo entrenado)
	@echo "$(BLUE)ğŸ”® Ejecutando predicciones...$(NC)"
	$(PYTHON) -m src.models.predict
	@echo "$(GREEN)âœ… Predicciones completadas$(NC)"

evaluate: ## Evaluar modelo en conjunto de validaciÃ³n
	@echo "$(BLUE)ğŸ“Š Evaluando modelo...$(NC)"
	@latest_pred=$$(ls -t data/predictions/predictions_*.csv | head -n 1); \
	echo "$(YELLOW)Usando predicciones: $$latest_pred$(NC)"; \
	$(PYTHON) -m src.models.evaluate \
		--predictions-path $$latest_pred \
		--actuals-path data/processed/valid_data.csv
	@echo "$(GREEN)âœ… EvaluaciÃ³n completada$(NC)"

eda: ## Abrir notebook de EDA
	@echo "$(BLUE)ğŸ“Š Abriendo notebook de EDA...$(NC)"
	$(PYTHON) -m jupyter notebook notebooks/01_eda.ipynb

notebooks: ## Iniciar Jupyter Lab
	@echo "$(BLUE)ğŸ““ Iniciando Jupyter Lab...$(NC)"
	$(PYTHON) -m jupyter lab

# ============================================================================
# API Y SERVICIOS
# ============================================================================

api: ## Iniciar API REST (FastAPI)
	@echo "$(BLUE)ğŸš€ Iniciando API en puerto $(PORT_API)...$(NC)"
	@echo "$(YELLOW)ğŸ“– DocumentaciÃ³n: http://localhost:$(PORT_API)/docs$(NC)"
	$(PYTHON) -m uvicorn src.api.main:app --reload --host 0.0.0.0 --port $(PORT_API)

api-prod: ## Iniciar API en modo producciÃ³n
	@echo "$(BLUE)ğŸš€ Iniciando API en modo producciÃ³n...$(NC)"
	$(PYTHON) -m uvicorn src.api.main:app --host 0.0.0.0 --port $(PORT_API) --workers 4

dashboard: ## Iniciar dashboard de Streamlit
	@echo "$(BLUE)ğŸ“Š Iniciando dashboard en puerto $(PORT_DASHBOARD)...$(NC)"
	$(PYTHON) -m streamlit run src/visualization/dashboard.py --server.port $(PORT_DASHBOARD)

# ============================================================================
# MLFLOW - TRACKING Y MODEL REGISTRY
# ============================================================================

mlflow-ui: ## Iniciar MLflow UI
	@echo "$(BLUE)ğŸ“Š Iniciando MLflow UI en http://localhost:$(PORT_MLFLOW)$(NC)"
	$(PYTHON) -m mlflow ui --host 0.0.0.0 --port $(PORT_MLFLOW)

mlflow-server: ## Iniciar MLflow server (tracking server)
	@echo "$(BLUE)ğŸš€ Iniciando MLflow tracking server...$(NC)"
	$(PYTHON) -m mlflow server --host 0.0.0.0 --port $(PORT_MLFLOW) --backend-store-uri sqlite:///mlflow.db --default-artifact-root ./mlruns

mlflow-list: ## Listar experimentos de MLflow
	@echo "$(BLUE)ğŸ“‹ Experimentos en MLflow:$(NC)"
	$(PYTHON) -m mlflow experiments list

mlflow-runs: ## Listar runs del experimento
	@echo "$(BLUE)ğŸ“‹ Runs del experimento:$(NC)"
	$(PYTHON) -m mlflow runs list --experiment-name walmart-forecasting

mlflow-clean: ## Limpiar experimentos de MLflow
	@echo "$(YELLOW)âš ï¸  Limpiando experimentos de MLflow...$(NC)"
	rm -rf mlruns/
	rm -f mlflow.db
	@echo "$(GREEN)âœ… MLflow limpiado$(NC)"

# ============================================================================
# MONITOREO
# ============================================================================

monitor: ## Ejecutar monitoreo de drift y performance
	@echo "$(BLUE)ğŸ“¡ Ejecutando monitoreo...$(NC)"
	$(PYTHON) -m src.monitoring.monitoring_run \
		--current-data data/processed/current_data.csv \
		--reference-data data/processed/train_data.csv
	@echo "$(GREEN)âœ… Monitoreo completado. Ver: reports/monitoring/$(NC)"

monitor-report: ## Ver Ãºltimo reporte de monitoreo
	@echo "$(BLUE)ğŸ“„ Abriendo reporte de monitoreo...$(NC)"
	cat reports/monitoring/monitoring_issues.json | python -m json.tool

drift-check: ## Verificar drift en datos de producciÃ³n
	@echo "$(BLUE)ğŸ” Verificando drift de datos...$(NC)"
	$(PYTHON) -m src.monitoring.drift_detection
	@echo "$(GREEN)âœ… VerificaciÃ³n de drift completada$(NC)"

# ============================================================================
# DOCKER
# ============================================================================

docker-build: ## Construir imagen Docker
	@echo "$(BLUE)ğŸ³ Construyendo imagen Docker...$(NC)"
	docker build -t $(PROJECT_NAME):latest .
	@echo "$(GREEN)âœ… Imagen construida: $(PROJECT_NAME):latest$(NC)"

docker-run: ## Ejecutar contenedor Docker
	@echo "$(BLUE)ğŸ³ Ejecutando contenedor...$(NC)"
	docker run -d -p $(PORT_API):$(PORT_API) --name walmart-api $(PROJECT_NAME):latest
	@echo "$(GREEN)âœ… Contenedor ejecutÃ¡ndose: http://localhost:$(PORT_API)$(NC)"

docker-stop: ## Detener contenedor Docker
	@echo "$(BLUE)ğŸ›‘ Deteniendo contenedor...$(NC)"
	docker stop walmart-api || true
	docker rm walmart-api || true
	@echo "$(GREEN)âœ… Contenedor detenido$(NC)"

docker-up: ## Levantar todos los servicios con docker-compose
	@echo "$(BLUE)ğŸ³ Levantando servicios con docker-compose...$(NC)"
	docker-compose up -d
	@echo "$(GREEN)âœ… Servicios iniciados$(NC)"
	@echo "$(YELLOW)API: http://localhost:$(PORT_API)$(NC)"
	@echo "$(YELLOW)Dashboard: http://localhost:$(PORT_DASHBOARD)$(NC)"
	@echo "$(YELLOW)MLflow: http://localhost:$(PORT_MLFLOW)$(NC)"

docker-down: ## Detener servicios de docker-compose
	@echo "$(BLUE)ğŸ›‘ Deteniendo servicios...$(NC)"
	docker-compose down
	@echo "$(GREEN)âœ… Servicios detenidos$(NC)"

docker-logs: ## Ver logs de docker-compose
	docker-compose logs -f

docker-rebuild: ## Reconstruir y reiniciar servicios
	@echo "$(BLUE)ğŸ”„ Reconstruyendo servicios...$(NC)"
	docker-compose down
	docker-compose build --no-cache
	docker-compose up -d
	@echo "$(GREEN)âœ… Servicios reconstruidos$(NC)"

# ============================================================================
# DEPLOYMENT
# ============================================================================

deploy-dev: ## Deploy en entorno de desarrollo
	@echo "$(BLUE)ğŸš€ Desplegando en DEV...$(NC)"
	./deployment/deploy.sh dev
	@echo "$(GREEN)âœ… Deployment DEV completado$(NC)"

deploy-staging: ## Deploy en entorno de staging
	@echo "$(BLUE)ğŸš€ Desplegando en STAGING...$(NC)"
	./deployment/deploy.sh staging
	@echo "$(GREEN)âœ… Deployment STAGING completado$(NC)"

deploy-prod: ## Deploy en entorno de producciÃ³n
	@echo "$(BLUE)ğŸš€ Desplegando en PRODUCCIÃ“N...$(NC)"
	./deployment/deploy.sh production
	@echo "$(GREEN)âœ… Deployment PRODUCCIÃ“N completado$(NC)"

# ============================================================================
# DATA PROCESSING
# ============================================================================

download-data: ## Descargar dataset M5 desde Kaggle
	@echo "$(BLUE)ğŸ“¥ Descargando dataset M5...$(NC)"
	kaggle competitions download -c m5-forecasting-accuracy
	unzip m5-forecasting-accuracy.zip -d data/raw/
	@echo "$(GREEN)âœ… Dataset descargado$(NC)"

process-data: ## Procesar datos raw
	@echo "$(BLUE)âš™ï¸ Procesando datos...$(NC)"
	$(PYTHON) -m src.data.make_dataset \
		--calendar-path data/raw/calendar.csv \
		--sales-path data/raw/sales_train_validation.csv \
		--prices-path data/raw/sell_prices.csv \
		--output-path data/processed/dataset.parquet
	@echo "$(GREEN)âœ… Datos procesados$(NC)"

features: ## Generar features
	@echo "$(BLUE)ğŸ”§ Generando features...$(NC)"
	$(PYTHON) -m src.features.build_features
	@echo "$(GREEN)âœ… Features generadas$(NC)"

# ============================================================================
# DOCUMENTACIÃ“N
# ============================================================================

docs: ## Generar documentaciÃ³n del proyecto
	@echo "$(BLUE)ğŸ“š Generando documentaciÃ³n...$(NC)"
	@echo "$(YELLOW)Documentos disponibles:$(NC)"
	@ls -lh docs/*.md
	@echo "$(GREEN)âœ… DocumentaciÃ³n disponible en docs/$(NC)"

readme: ## Abrir README principal
	@less README_FINAL.md

audit: ## Mostrar auditorÃ­a DVP-PRO
	@less AUDITORIA_DVP_PRO.md

# ============================================================================
# GIT
# ============================================================================

git-status: ## Ver estado del repositorio
	@git status

git-log: ## Ver historial de commits
	@git log --oneline --graph --all -10

commit: ## Commit rÃ¡pido (use: make commit m="mensaje")
	@if [ -z "$(m)" ]; then \
		echo "$(RED)âŒ Error: Especifica mensaje con m=\"mensaje\"$(NC)"; \
		exit 1; \
	fi
	git add .
	git commit -m "$(m)"
	@echo "$(GREEN)âœ… Commit realizado$(NC)"

# ============================================================================
# UTILIDADES
# ============================================================================

info: ## Mostrar informaciÃ³n del proyecto
	@echo "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(BLUE)â•‘  $(GREEN)Walmart Demand Forecasting - Project Info$(BLUE)            â•‘$(NC)"
	@echo "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(YELLOW)Proyecto:$(NC)     $(PROJECT_NAME)"
	@echo "$(YELLOW)VersiÃ³n:$(NC)      1.2.0"
	@echo "$(YELLOW)Python:$(NC)       $$($(PYTHON) --version)"
	@echo "$(YELLOW)Autor:$(NC)        Ing. Daniel Varela Perez"
	@echo "$(YELLOW)Email:$(NC)        bedaniele0@gmail.com"
	@echo "$(YELLOW)MetodologÃ­a:$(NC)  DVP-PRO"
	@echo ""
	@echo "$(YELLOW)Dataset:$(NC)      M5 Forecasting (Walmart)"
	@echo "$(YELLOW)Series:$(NC)       30,490 product-store combinations"
	@echo "$(YELLOW)PerÃ­odo:$(NC)      2011-2016 (5.4 aÃ±os)"
	@echo ""

setup: venv install-dev ## Setup completo inicial (venv + install-dev)
	@echo "$(GREEN)âœ… Setup inicial completado$(NC)"
	@echo "$(YELLOW)ğŸ’¡ Activa el entorno: source $(VENV)/bin/activate$(NC)"

pipeline: process-data features train evaluate ## Ejecutar pipeline completo
	@echo "$(GREEN)âœ… Pipeline completo ejecutado$(NC)"

# Default target
.DEFAULT_GOAL := help
